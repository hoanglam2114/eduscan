<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Upload Test - EduScan</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .test-box {
            border: 2px solid #ccc;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        .success { background: #d4edda; border-color: #28a745; }
        .error { background: #f8d7da; border-color: #dc3545; }
        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
        }
        #preview img {
            max-width: 200px;
            margin: 10px;
            border: 1px solid #ccc;
        }
        #log {
            background: #000;
            color: #0f0;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
<h1>üîß EduScan Upload Test Page</h1>
<p>This is a simplified test page to debug file upload issues.</p>

<div class="test-box">
    <h3>Step 1: Select File</h3>
    <input type="file" id="testFileInput" accept="image/*" multiple>
    <p id="fileInfo"></p>
</div>

<div class="test-box">
    <h3>Step 2: Preview</h3>
    <div id="preview"></div>
</div>

<div class="test-box">
    <h3>Step 3: Test Upload</h3>
    <button onclick="testUpload()">Test API Upload</button>
    <div id="result"></div>
</div>

<div class="test-box">
    <h3>Console Log</h3>
    <div id="log"></div>
</div>

<script>
    const logDiv = document.getElementById('log');
    const fileInfoDiv = document.getElementById('fileInfo');
    const previewDiv = document.getElementById('preview');
    const resultDiv = document.getElementById('result');
    let selectedFiles = [];

    // Override console.log to show in page
    const originalLog = console.log;
    console.log = function(...args) {
        originalLog.apply(console, args);
        logDiv.innerHTML += args.join(' ') + '<br>';
        logDiv.scrollTop = logDiv.scrollHeight;
    };

    console.log('=== Test Page Loaded ===');
    console.log('Current URL:', window.location.href);
    console.log('API URL:', window.location.origin);

    // File input handler
    document.getElementById('testFileInput').addEventListener('change', function(e) {
        console.log('File input changed');
        selectedFiles = Array.from(e.target.files);
        console.log('Files selected:', selectedFiles.length);

        if (selectedFiles.length === 0) {
            fileInfoDiv.innerHTML = '<span style="color: red;">No files selected</span>';
            return;
        }

        // Show file info
        let info = '<strong>Selected Files:</strong><br>';
        selectedFiles.forEach((file, i) => {
            console.log(`File ${i + 1}:`, file.name, file.type, file.size, 'bytes');
            info += `${i + 1}. ${file.name} (${file.type}, ${(file.size / 1024).toFixed(2)} KB)<br>`;
        });
        fileInfoDiv.innerHTML = info;

        // Show preview
        previewDiv.innerHTML = '';
        selectedFiles.forEach(file => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.createElement('img');
                img.src = e.target.result;
                previewDiv.appendChild(img);
            };
            reader.readAsDataURL(file);
        });
    });

    // Test upload function
    async function testUpload() {
        console.log('=== Starting Upload Test ===');

        if (selectedFiles.length === 0) {
            resultDiv.innerHTML = '<p style="color: red;">Please select files first!</p>';
            return;
        }

        resultDiv.innerHTML = '<p>‚è≥ Uploading...</p>';

        const formData = new FormData();
        selectedFiles.forEach(file => {
            console.log('Adding to FormData:', file.name);
            formData.append('files', file);
        });

        // Log FormData contents
        console.log('FormData entries:');
        for (let pair of formData.entries()) {
            console.log(pair[0], ':', pair[1].name || pair[1]);
        }

        const apiUrl = window.location.origin + '/api/ocr/scan-multiple';
        console.log('Calling API:', apiUrl);

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                body: formData
            });

            console.log('Response status:', response.status);
            console.log('Response ok:', response.ok);

            if (!response.ok) {
                const errorText = await response.text();
                console.log('Error response:', errorText);
                resultDiv.innerHTML = `<p style="color: red;">‚ùå Error: ${response.status}<br>${errorText}</p>`;
                return;
            }

            const data = await response.json();
            console.log('Response data:', data);

            // Display results
            let html = '<div style="color: green;"><strong>‚úÖ Success!</strong></div>';
            data.forEach((item, i) => {
                html += `<div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc;">`;
                html += `<strong>File ${i + 1}: ${item.fileName}</strong><br>`;
                if (item.success) {
                    html += `<div style="background: #f0f0f0; padding: 10px; margin-top: 10px; max-height: 200px; overflow-y: auto;">`;
                    html += `<pre>${item.extractedText}</pre>`;
                    html += `</div>`;
                } else {
                    html += `<span style="color: red;">Error: ${item.error}</span>`;
                }
                html += `</div>`;
            });
            resultDiv.innerHTML = html;

        } catch (error) {
            console.log('Fetch error:', error);
            resultDiv.innerHTML = `<p style="color: red;">‚ùå Network Error: ${error.message}</p>`;
        }
    }

    // Test backend health
    console.log('Testing backend health...');
    fetch(window.location.origin + '/api/ocr/health')
        .then(r => r.text())
        .then(t => console.log('‚úÖ Backend health:', t))
        .catch(e => console.log('‚ùå Backend health error:', e.message));
</script>
</body>
</html>